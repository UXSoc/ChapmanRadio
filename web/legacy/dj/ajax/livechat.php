<?php namespace ChapmanRadio;define('PATH', '../../');require_once PATH."inc/global.php";/* This page can only be used by a currently-broadcasting DJ. */if(!DJLive::isActive()) die(json_encode(array("error"=>"Error 403: Permission Denied. Your DJ Live session has ended. If this isn't correct, contact webmaster")));$json = array();$json['msgs'] = array();$action = Request::Get('action', '');if($action == 'livechat-sync'){	$last = Request::GetInteger('last', 0);	$since = date('Y-m-d H:00:00');		$chats = LiveChat::getChatsSince($since, $last, true);	foreach($chats as $chat){				// commands		if(strpos($chat['message'], LiveChat::CommandPrefix) === 0){			$cmd = substr($chat['message'], strlen(LiveChat::CommandPrefix));			if(preg_match("/^\s*(poptartcat.*)$/", $cmd, $matches)) $json['egg'] = $matches[1];			continue;			}				// blacklist		if($chat['contactid'] == "key541b6e14dcad3") continue;				if(!isset($json['msgs'][$chat['contactid']])) $json['msgs'][$chat['contactid']] = array("smsdata"=>array());		$json['msgs'][$chat['contactid']]['label'] = $chat['label'];		$json['msgs'][$chat['contactid']]['smsdata'][$chat['livechatid']] = $chat;		}		die(json_encode($json));	}else if($action == 'livechat-send'){	$contactid = @$_REQUEST['contactid'] or die(json_encode("error: missing contactid variable"));	$message = @$_REQUEST['message'] or die(json_encode("error: missing message variable"));	if(strlen($message) > 160*3) die(json_encode("error: text message is too long. yours was ".strlen($message)." characters"));	$message = stripslashes(strip_tags($message, "<b><i><small><em><strong>"));	$livechatid = LiveChat::send($contactid, $message);	if(!$livechatid) die(json_encode("error: failed to send text message. unknown error."));	$json['msgs'][$contactid]['smsdata'] = array($livechatid=>array("direction"=>"out","message"=>$message,"time"=>date('g:ia') ));	die( json_encode( $json ) );	}die( json_encode( $json ) );